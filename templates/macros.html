{% macro list_selector(list, name, title, tooltip, size, includeDisclaimer=0, overrideDisclaimer="") %}
    <!-- Icon triggers modal -->
    <input class="customize"
           type="button"
           href="#"
           id="{{ name }}_modal"
           data-bs-toggle="modal"
           data-bs-target="#{{ name }}_Modal"
           data-toggle="tooltip"
           title="{{ tooltip }}"/>
</div>
<!-- Modal -->
<div class="modal fade"
     id="{{ name }}_Modal"
     tabindex="-1"
     aria-labelledby="{{ name }}_ModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title title" id="{{ name }}_ModalLabel">{{ title }}</h3>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="item-multiselect" style="margin-left: 105px;">
                    <div class="color-selector">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div class="input-group-text search">
                                    <input type="text"
                                           class="form-control"
                                           id="{{ name }}_search_box"
                                           name="search"
                                           placeholder="Search"/>
                                </div>
                            </div>
                            <select name="{{ name }}_selected"
                                    id="{{ name }}_selected"
                                    class="form-select multi-select selected"
                                    aria-label="List_Selector"
                                    multiple
                                    size="{{ size }}">
                                {% for item in list %}
                                    <option value="{{ item.value }}" title="{{ item.tooltip }}">
                                        {{ item.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                {% if overrideDisclaimer != "" %}
                    <div class="fst-italic">
                        <div>{{ overrideDisclaimer }}</div>
                    </div>
                {% endif %}
                {% if includeDisclaimer %}
                    <div class="fst-italic">
                        <div>If nothing is selected, all options are treated as selected.</div>
                        <div>Disable the setting slider to disable all options.</div>
                    </div>
                {% endif %}
                {% if name == "minigames_list" %}
                    <div class="form-check form-switch" style="padding-left: 1.5em;">
                        <label data-toggle="tooltip"
                            style="font-size:14px;"
                            title="The hardest variants of minigames are removed.">
                            <input class="form-check-input"
                                type="checkbox"
                                name="disable_hard_minigames"
                                id="disable_hard_minigames"
                                value="True"/>
                            No Hard Minigames
                        </label>
                    </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="{{ name }}_select_all">Select All</button>
                <button type="button" class="btn btn-secondary" id="{{ name }}_reset">Reset</button>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    $('#{{ name }}_selected option').mousedown(function(e) {
        var el = e.target
    
        $(this).prop('selected', !$(this).prop('selected'));
        $(this).trigger('change');
    
        // fixes erratic scroll behavior in Chrome
        var scrollTop = el.parentNode.scrollTop;
        setTimeout(() => el.parentNode.scrollTo(0, scrollTop), 0);
    
        return false;
    });
    
    $('#{{ name }}_select_all').click(function() {
        $('#{{ name }}_selected option').prop('selected', true);
        $('#{{ name }}_selected').trigger('change');
    });
    
    $('#{{ name }}_reset').click(function() {
        $('#{{ name }}_selected option:selected').prop('selected', false);
        $('#{{ name }}_selected').trigger('change');
    });
    
    $('#{{ name }}_search_box').keyup(function() {
        var keyword = document.getElementById("{{ name }}_search_box").value;
        var select = document.getElementById("{{ name }}_selected");
        for (var i = 0; i < select.length; i++) {
            var txt = select.options[i].text;
            if (txt.substring(0, keyword.length).toLowerCase() !== keyword.toLowerCase() && keyword.trim() !== "") {
                select.options[i].style.display = 'none';
            } else {
                select.options[i].style.display = 'list-item';
            }
        }
    });
</script>
{% endmacro %}
{% macro properties_selector(list, name, title, tooltip) %}
    <!-- Icon triggers modal -->
    <input class="customize"
           type="button"
           href="#"
           id="{{ name }}_modal"
           data-bs-toggle="modal"
           data-bs-target="#{{ name }}_Modal"
           data-toggle="tooltip"
           title="{{ tooltip }}"/>
</div>
<!-- Modal -->
<div class="modal fade"
     id="{{ name }}_Modal"
     tabindex="-1"
     aria-labelledby="{{ name }}_ModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" style="max-width:700px">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title title" id="{{ name }}_ModalLabel">{{ title }}</h3>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div>
                    <div class="flex-container">
                        {% for item in list %}
                            <div class="item-select" style="margin:0;flex:0;min-width:150px;">
                                <p class="select-title">{{ item.name }}</p>
                                {% if item.name == "Starting Time" %}
                                    <input 
                                    min="0"
                                    max="65535"
                                    name="{{ name }}_{{ item.value }}"
                                    id="{{ name }}_{{ item.value }}"
                                    style="width:15%"
                                    class="form-control center-div"
                                    type="number"
                                    value="{{ item.default }}"
                                    default_val="{{ item.default }}">
                                {% else %}
                                    <input 
                                    min="-32768"
                                    max="32767"
                                    name="{{ name }}_{{ item.value }}"
                                    id="{{ name }}_{{ item.value }}"
                                    style="width:15%"
                                    class="form-control center-div"
                                    type="number"
                                    value="{{ item.default }}"
                                    default_val="{{ item.default }}">
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="{{ name }}_reset">Reset</button>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    $('#{{ name }}_reset').click(function() {
        {% for item in list %}
            $('#{{ name }}_{{ item.value }}').prop('value', $('#{{ name }}_{{ item.value }}').attr('default_val'))
            $('#{{ name }}_{{ item.value }}').trigger('change')
        {% endfor %}
    })
</script>
{% endmacro %}
{% macro toggle_input(id, name, tooltip="", default_checked=False, altered_name="") %}
<div class="form-check form-switch item-switch" data-toggle="tooltip"
            title="{{ tooltip }}">
    {% if default_checked %}
        <input
            class="form-check-input"
            type="checkbox"
            role="switch"
            name="{{ id }}"
            id="{{ id }}"
            display_name="{{ name }}"
            value="True" checked />
    {% else %}
        <input
            class="form-check-input"
            type="checkbox"
            role="switch"
            name="{{ id }}"
            id="{{ id }}"
            display_name="{{ name }}"
            value="True" />
    {% endif %}
    <label class="form-check-label" for="{{ id }}">
        {% if altered_name == "" %}
            {{ name }}
        {% else %}
            {{ altered_name }}
        {% endif %}
    </label>
</div>
{% endmacro %}

{% macro slider_input(id, name, min_value, max_value) %}
    <input type="range"
        name="{{ id }}"
        id="{{ id }}"
        display_name="{{ name }}"
        min="{{ min_value }}"
        max="{{ max_value }}"
        style="width: 80%"
        class="pretty-slider"
        list="{{ id }}_tickmarks">
    <datalist id="{{ id }}_tickmarks" style="width: 80%; margin-top: -10px" class="d-flex justify-content-between mx-auto px-1">
        {% for val in range(min_value, max_value + 1) %}
            <option value="{{ val }}" label="{{ val }}"></option>
        {% endfor %}
    </datalist>
    <script>
        ["change", "input", "load"].forEach(evt => {
            document.getElementById("{{ id }}").addEventListener(evt, (e) => {
                const targ_value = e.target.value;
                const targ_min = e.target.getAttribute("min");
                const targ_max = e.target.getAttribute("max");
                const targ_delta = targ_max - targ_min;
                const value_delta = targ_value - targ_min;
                e.target.style.setProperty("--p", `${parseInt(100 * (value_delta / targ_delta))}%`)
            })
        })
    </script>
{% endmacro %}
{% macro switchsanity_option(name, setting, subtype, default) %}
    <div class="col">
        <div class="item-select">
            <p class="select-title">{{ name }}</p>
            <select name="{{ setting }}"
                    id="{{ setting }}"
                    class="form-select"
                    aria-label="Randomization type"
                    display_name="name"
                    data-toggle="tooltip"
                    title="Switch assigned to {{ name }}.">
                {% if subtype != "gone_to_helm" %}
                    {% if subtype != "free_tiny" %}
                        <option id="donkey" {% if default == "donkey" %}selected{% endif %} value="donkey">
                            {% if subtype == "guns" %}Coconut
                            {% elif subtype == "instruments" %}Bongos
                            {% elif subtype == "kong" %}Donkey
                            {% elif subtype == "mport_to_helm" %}Blast
                            {% elif subtype == "free_lanky" %}Bongos/Coconut
                            {% elif subtype == "free_tiny" %}You should not see this
                            {% endif %}
                        </option>
                    {% endif %}
                    {% if subtype != "mport_to_helm" %}
                        <option id="diddy" {% if default == "diddy" %}selected{% endif %} value="diddy">
                            {% if subtype == "guns" %}Peanut
                            {% elif subtype == "instruments" %}Guitar
                            {% elif subtype == "kong" %}Diddy
                            {% elif subtype == "mport_to_helm" %}You should not see this
                            {% elif subtype == "free_lanky" %}Guitar/Peanut
                            {% elif subtype == "free_tiny" %}Chimpy Charge
                            {% endif %}
                        </option>
                    {% endif %}
                    {% if subtype != "free_tiny" %}
                        <option id="lanky" {% if default == "lanky" %}selected{% endif %} value="lanky">
                            {% if subtype == "guns" %}Grape
                            {% elif subtype == "instruments" %}Trombone
                            {% elif subtype == "kong" %}Lanky
                            {% elif subtype == "mport_to_helm" %}Balloon
                            {% elif subtype == "free_lanky" %}Trombone/Grape
                            {% elif subtype == "free_tiny" %}You should not see this
                            {% endif %}
                        </option>
                    {% endif %}
                    {% if subtype != "free_tiny" %}
                        <option id="tiny" {% if default == "tiny" %}selected{% endif %} value="tiny">
                            {% if subtype == "guns" %}Feather
                            {% elif subtype == "instruments" %}Saxophone
                            {% elif subtype == "kong" %}Tiny
                            {% elif subtype == "mport_to_helm" %}Monkeyport
                            {% elif subtype == "free_lanky" %}Saxophone/Feather
                            {% elif subtype == "free_tiny" %}You should not see this
                            {% endif %}
                        </option>
                    {% endif %}
                    {% if subtype != "mport_to_helm" %}
                        <option id="chunky" {% if default == "chunky" %}selected{% endif %} value="chunky">
                            {% if subtype == "guns" %}Pineapple
                            {% elif subtype == "instruments" %}Triangle
                            {% elif subtype == "kong" %}Chunky
                            {% elif subtype == "mport_to_helm" %}You should not see this
                            {% elif subtype == "free_lanky" %}Triangle/Pineapple
                            {% elif subtype == "free_tiny" %}Primate Punch
                            {% endif %}
                        </option>
                    {% endif %}
                {% else %}
                    <option id="bongos" {% if default == "bongos" %}selected{% endif %} value="bongos">Bongos</option>
                    <option id="guitar" {% if default == "guitar" %}selected{% endif %} value="guitar">Guitar</option>
                    <option id="trombone" {% if default == "trombone" %}selected{% endif %} value="trombone">Trombone</option>
                    <option id="sax" {% if default == "sax" %}selected{% endif %} value="sax">Saxophone</option>
                    <option id="triangle" {% if default == "triangle" %}selected{% endif %} value="triangle">Triangle</option>
                    <option id="lever" {% if default == "lever" %}selected{% endif %} value="lever">Grab Lever</option>
                    <option id="gong" {% if default == "gong" %}selected{% endif %} value="gong">Gong</option>
                    <option id="gone_pad" {% if default == "gone_pad" %}selected{% endif %} value="gone_pad">Gorilla Gone</option>
                {% endif %}
                <option id="random" {% if default == "random" %}selected{% endif %} value="random">
                    Random
                </option>
            </select>
        </div>
    </div>
{% endmacro %}

{% macro dropdown_multiselector(list, name, title, tooltip, size, includeDisclaimer=0, overrideDisclaimer="") %}
    <div class="item-select">
        <p class="select-title">{{ title }}</p>
        <div class="dropdown-multiselect" id="dropdown_{{ name }}">
            <!-- Visible toggle -->
            <div class="dropdown-toggle" onclick="toggleDropdown('{{ name }}')" title="{{ tooltip }}">
                <span id="selectedCount_{{ name }}">Loading Multiselector...</span>
            </div>
    
            <!-- Dropdown menu -->
            <div class="dropdown-menu" name="{{ name }}_selected" id="{{ name }}_selected">
                <div class="d-flex" style="border-bottom: 1px solid #bbb; margin-bottom: 5px; padding-bottom: 10px;">
                    <span class="mx-2 control-button user-select-none" onclick="dropdownForceAll('{{ name }}', true)">All</span>
                    <span class="mx-2 control-button user-select-none" onclick="dropdownForceAll('{{ name }}', false)">None</span>
                </div>
                {% for option in list %}
                    <label class="dropdown-item" title="{{ option.tooltip }}">
                        <input type="checkbox" class="avoid-settings-parse" value="{{ option.value }}"
                            onchange="updateSelected('{{ name }}')"
                            >
                        {{ option.name }}
                    </label>
                {% endfor %}
            </div>
        </div>
    </div>
{% endmacro %}

{% macro sortable_itemrando(list, name, title, count) %}
    <!-- This one is SPECIFIC TO ITEM RANDO - DO NOT USE OUTSIDE OF THE ITEM RANDO MODAL -->
    <div class="modal fade"
     id="{{ name }}_Modal"
     tabindex="-1"
     aria-labelledby="{{ name }}_ModalLabel"
     aria-hidden="true">
        <div class="modal-dialog" style="max-width: 1250px;">
            <div class="modal-content modal-content-tall">
                <div class="modal-header">
                    <h3 class="modal-title title" id="{{ name }}_ModalLabel">{{ title }}</h3>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-start">
                        <p>
                            Shuffles <span class="ir-hint items">items</span> with <span class="ir-hint checks">checks</span> into pools.
                            Drag and drop items and checks into various pools to determine where items can be placed.
                        </p>
                        <h5>Rules</h5>
                        <ul>
                            <li id="rule-item-shuffle">If an item or check remains unshuffled, it's corresponding item/check has to also remain unshuffled.</li>
                            <li id="rule-item-count">Check count must not be lower than item count.</li>
                        </ul>
                    </div>
                    <div class="d-flex" id="{{ name }}-category-container" data-items="{{ list | tojsonarr | escape }}" data-count="{{ count }}" data-predicate="{{ name }}_list_">
                        {% for x in range(count) %}
                        <div style="flex:1; max-width: 20%;">
                            <p class="select-title" style="margin-bottom: 0px;">
                                {% if x == 0%}
                                    Unshuffled
                                {% else %}
                                    Pool {{ x }}
                                {% endif %}
                            </p>
                            <div id="{{ name }}_check_hint_{{ x }}" style="min-height: 24px; margin-bottom: 10px;"></div>
                            <ul id="{{ name }}_list_{{ x }}" name="{{ name }}_list_{{ x }}" class="sortablejs shared list-group bg-secondary-subtle border border-1 border-white mx-2" style="height: 400px; overflow-y: scroll">
                                {% if x == 0 %}
                                    {% for option in list %}
                                        {% if option.is_check %}
                                            <li class="list-group-item ischeck" value="{{ option.value }}" tooltip="{{ option.tooltip }}" check_count="{{ option.check_count }}" items_count="{{ option.item_count }}" tied_item="{{ option.tied }}">{{ option.name }}</li>
                                        {% else %}
                                            <li class="list-group-item" value="{{ option.value }}" tooltip="{{ option.tooltip }}" check_count="{{ option.check_count }}" items_count="{{ option.item_count }}">{{ option.name }}</li>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </ul>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="{{ name }}_reset">Unshuffle All</button>
                    <button type="button" class="btn btn-secondary" id="{{ name }}_shuffle_all">Shuffle All</button>
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const sort_container = document.getElementById("{{ name }}-category-container");
        const sort_sections = sort_container.getElementsByTagName("ul");
        for (let section of sort_sections) {
            new Sortable(section, {
                group: 'shared',
                animation: 150,
                fallbackTolerance: 3,
                sort: false,
                onEnd: (evt) => {
                    const event = new Event("change", { bubbles: true, cancelable: false });
                    evt.to.dispatchEvent(event);
                    updateCheckItemCounter(evt.to.parentElement.parentElement);
                }
            });
        }

        function isNumeric(str) {
            if (typeof str != "string") return false // we only process strings!  
            return !isNaN(str) && // use type coercion to parse the _entirety_ of the string (`parseFloat` alone does not do this)...
                    !isNaN(parseFloat(str)) // ...and ensure strings of whitespace fail
        }

        function updateCheckItemCounter(ctr) {
            const name = ctr.getAttribute("id").split("-category-container")[0];
            const sort_sections = ctr.getElementsByTagName("ul");
            let index = 0;
            let is_valid_item_spread = true;
            
            let item_shuffle_cache = {};
            let item_shuffle_tied = {}
            for (let section of sort_sections) {
                let local_check_count = 0;
                let local_item_count = 0;
                let parsed_options = 0;
                const options = section.getElementsByTagName("li");
                for (let option of options) {
                    const check_count_raw = option.getAttribute("check_count");
                    const item_count_raw = option.getAttribute("item_count");
                    const tied_item_raw = option.getAttribute("tied_item");
                    item_shuffle_cache[option.getAttribute("value")] = index;
                    if (tied_item_raw) {
                        item_shuffle_tied[option.getAttribute("value")] = tied_item_raw;
                    }
                    if (isNumeric(check_count_raw)) {
                        local_check_count += parseInt(check_count_raw);
                    }
                    if (isNumeric(item_count_raw)) {
                        local_item_count += parseInt(item_count_raw);
                    }
                    parsed_options++;
                }
                if (index > 0) {
                    let inner_text = "";
                    if (parsed_options > 0) {
                        inner_text = `Checks: ${local_check_count} | Items: ${local_item_count}`;
                    }
                    if (local_item_count > local_check_count) {
                        is_valid_item_spread = false;
                    }
                    const text_color = local_item_count > local_check_count ? "red" : "green";
                    const check_hint_el = document.getElementById(`${name}_check_hint_${index}`);
                    check_hint_el.innerHTML = inner_text;
                    check_hint_el.style.color = text_color;
                }
                index++;
            }
            let is_valid_item_shuffle = true;
            Object.keys(item_shuffle_tied).forEach(key => {
                const val = item_shuffle_tied[key];
                const key_slot = item_shuffle_cache[key];
                const val_slot = item_shuffle_cache[val];
                if (key_slot != val_slot) {
                    if ((key_slot == 0) || (val_slot == 0)) {
                        // Key or val is in slot 0, but not both
                        is_valid_item_shuffle = false;
                    }
                }
            })
            document.getElementById("rule-item-count").style.color = is_valid_item_spread ? "white" : "red";
            document.getElementById("rule-item-shuffle").style.color = is_valid_item_shuffle ? "white" : "red";
        }


        function setAllToColumn(name, index) {
            const container = document.getElementById(`${name}-category-container`);
            const uls = container.getElementsByTagName("ul");
            let total_html = "";
            for (let i = 0; i < uls.length; i++) {
                total_html += uls[i].innerHTML;
            }
            for (let i = 0; i < uls.length; i++) {
                if (i == index) {
                    uls[index].innerHTML = total_html;
                } else {
                    uls[i].innerHTML = "";
                }
                const event = new Event("change", { bubbles: true, cancelable: false });
                uls[i].dispatchEvent(event);
            }
            updateCheckItemCounter(container);
        }

        document.getElementById("{{ name }}_reset").addEventListener("click", (e) => {setAllToColumn("{{ name }}", 0)});
        document.getElementById("{{ name }}_shuffle_all").addEventListener("click", (e) => {setAllToColumn("{{ name }}", 1)});
    </script>
{% endmacro %}